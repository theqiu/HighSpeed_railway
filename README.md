# 检修数据分析与可视化平台

本项目提供一个基于 Streamlit 的检修数据分析平台，用于读取 CSV 格式的检修记录，完成数据清洗、筛选、统计分析与可视化展示。通过上传数据或使用示例数据，用户可以快速查看不同批次、检测项目、检修人员的工作量与质量情况，并将结果导出。

## 功能概览

- **数据加载与预处理**：自动解析列名、时间字段以及检修状态，兼容科学计数法表示的时间戳。
- **灵活筛选**：支持按轮对型号、轮对号/条码号、检修项目、检修人员、工序项目、车组号及日期范围组合筛选数据。
- **统计指标**：展示总记录数、合格/不合格/未知等核心指标，帮助快速了解整体质量情况。
- **可视化图表**：提供状态分布饼图、时间趋势折线图、状态堆叠面积图、Top 排行条形图、人员与项目热力图等。
- **高级分析**：新增轮座尺寸规律识别、设备与人工复测偏差预警、轮径与轮缘组合模型提示等场景化分析模块。
- **数据导出**：除 CSV 外，还可一键生成 Excel/Word/PDF 报告，并支持将任意图表导出为 JPG 图片。

## 目录结构

```
.
├── app
│   ├── __init__.py
│   ├── analytics.py          # 统计分析逻辑
│   ├── data_processing.py    # 数据读取与预处理
│   ├── main.py               # Streamlit 应用入口
│   ├── visualization.py      # Plotly 图表封装
│   └── exporting.py          # 多格式导出工具
├── data
│   ├── 2025年6-9月.csv          # 默认加载的生产数据示例
│   └── sample_inspections.csv  # 精简示例数据
├── README.md
└── requirements.txt (需自行创建，用于安装依赖)
```

> **提示**：示例数据仅用于演示界面效果，真实使用时请上传来自 AE 系统的最新 CSV 数据。

## 快速开始

### 1. 创建虚拟环境并安装依赖

```bash
python -m venv .venv
source .venv/bin/activate  # Windows 使用 .venv\Scripts\activate
pip install -U pip
pip install -r requirements.txt
```

如果尚未创建 `requirements.txt`，可以参考下方依赖列表。

### 2. 运行 Streamlit 应用

```bash
streamlit run app/main.py
```

启动后在浏览器中访问控制台输出的地址（默认 http://localhost:8501）。左侧侧边栏可上传 CSV 文件或直接使用示例数据进行体验。

### 3. 上传数据并分析

1. 点击侧边栏的“上传 CSV 文件”，选择检修记录。
2. 利用轮对型号、轮对号/条码号、检修项目、检修人员、工序项目、车组号与日期范围组合筛选目标数据。
3. 在首页查看统计卡片、状态分布及时间趋势，快速掌握整体质量情况。
4. 通过页面中的“分析模块”下拉框，按需切换轮对矩阵、排行、预警等专题视图；在需要时可导出筛选明细或报表。

## 数据要求

| 列名         | 说明                       | 示例                     |
| ------------ | -------------------------- | ------------------------ |
| `#`          | 行号（可作为事实表主键）   | `1`                      |
| `lotno`      | 与轮对号对应的批次编号，通常与生产日期相关 | `20201018-0043`          |
| `xb005`      | 轮对号（最重要的实体，每个轮对包含大量记录） | `109T3C2332`             |
| `opno`       | 检修流程（如轴盘压装、车轮压装等）         | `轴盘压装`                |
| `qcitem`     | 对应流程的细分检测项目或参数               | `中盘位平均值`            |
| `qcorder`    | 流程执行顺序，部分轮对可能缺失             | `001` / 空               |
| `inputvalue` | 检测结果：可能是“合格:1;不合格:0;”这类标记，也可能是数值或日期 | `508.93`、`2016-05`      |
| `creator`    | 检修人员编号               | `ZS0042`                 |
| `qcdate`     | 检测时间（格式：YYYYMMDDHHMMSS 或科学计数法） | `20240117110418` |
| `rn`         | 序号/辅助字段              | `1`                      |

程序会自动完成以下清洗与特征提取：

- 将 `qcdate` 解析为 `qc_timestamp`（`datetime`）并派生 `year/month/day` 列。
- 根据 `inputvalue` 与 `qcorder` 提取合格/不合格/不适用状态，写入 `status` 列。
- 根据轮对号 `xb005` 推断对应的轮对型号与所属平台（`wheel_model`、`wheel_platform`），用于筛选与统计。
- 尝试将纯数字的 `inputvalue` 转换为 `numeric_value`，用于趋势分析。

## 展示模块

最新版界面在展示层面做了分区：主页聚焦总体概览，其余专题可通过“分析模块”下拉框按需加载，既减轻一次性渲染压力，也让操作流程更清晰。

可选模块包括：

1. **人员与项目排行**：提供检修人员与检测项目 Top 排行，并附带人员-项目关联热力图。
2. **轮对流程覆盖矩阵**：横轴为轮对号 (`xb005`)，纵轴为检修流程 (`opno`)，通过滑动窗口快速定位缺失流程。
3. **轮座尺寸规律检测**：按轮型筛选轮座相关测点，自动识别是否满足“由内向外逐渐减小”的规律，可针对单个轮对绘制平均截面趋势曲线并提示异常。
4. **检测项目数值趋势**：自动识别可转为数值的 `qcitem`，比较不同轮对的最新检测值及其趋势。
5. **设备与人工复测偏差分析**：选择设备输出与人工复尺项目，统计偏差时间序列与月度超阈值次数，超过 N 次自动高亮预警。
6. **组合指标预警模型**：联动轮径与轮缘厚度等指标，当轮径未超限但轮缘偏小时提前提示需要换轮。
7. **轮对检测项目明细表**：多选轮对号查看详细 `qcitem`、顺序与检测结果，可导出 CSV。
8. **筛选数据明细**：直接浏览当前筛选条件下的原始数据并导出 CSV。
9. **导出与分享**：按需生成 Excel/Word/PDF 报告或导出图表 JPG。

上述模块与首页概览共同组成了完整的检修质量分析看板，既能满足日常巡检，也支持深入的质量趋势挖掘与建模预警。

## 常见扩展需求

- **与 AE 系统接口对接**：可在 `data_processing.py` 中新增定时任务或 API 调用逻辑，将 CSV 导入替换为接口数据。
- **指标自定义**：在 `analytics.py` 中新增聚合逻辑，例如按工序、班组计算合格率，或计算返修次数等。
- **界面美化**：在 `main.py` 中调整布局、主题或添加更多图表，满足不同角色的展示需求。
- **权限控制**：Streamlit 支持接入 SSO 或者部署在受限网络下，确保敏感数据安全。

## 依赖建议

将以下依赖写入 `requirements.txt`：

```
streamlit>=1.32
pandas>=2.1
plotly>=5.18
numpy>=1.26
openpyxl>=3.1
python-docx>=0.8
reportlab>=4.0
kaleido>=0.2
```

如需在服务器部署，可额外添加 `gunicorn` 等进程管理工具。

## 开发计划参考

1. **数据清洗与探索**：核对字段含义、填补缺失值、确认关键指标口径。
2. **原型搭建**：利用示例数据搭建界面，验证筛选与图表联动是否符合需求。
3. **接口联调**：对接 AE 提供的数据接口，替换示例数据源并加入数据同步机制。
4. **美化与扩展**：根据业务反馈迭代图表类型、添加导出/报告功能等。
5. **部署与运维**：容器化部署、配置日志与监控，确保上线后的稳定性。

---

如在使用过程中遇到问题或需要新增功能，可在 Issue 中反馈或直接修改对应模块。
